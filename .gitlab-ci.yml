
stages:
    - check
    - deploy
    
cache:
  paths:
    - vendor/

lint_php:
    stage: check
    image: cyberpearuk/php-build-docker
    script: phplint --exclude=vendor ./
    
deploy_nexus:
    stage: deploy
    image: cyberpearuk/php-build-docker
    script:
        - php <(curl -s https://gist.githubusercontent.com/jbuncle/8e479343cfeb785046e3c6fe1a73dcce/raw/nexus-upload.php)
         --repository=https://nexus.jbuncle.co.uk/repository/composer-private/ 
         --username=composer-publisher 
         --password=$NEXUS_PASS 
         --version=$CI_COMMIT_TAG
         --ignore="/^(nbproject.*|\.gitlab\-ci\.yml|Dockerfile)$/"
    only:
        refs:
            - master
            
deploy_docker:
    stage: deploy
    image: "docker:latest"
    services:
      - docker:dind
    script: 
        - rm -rf nbproject
        - docker build -t docker.jbuncle.co.uk/jbuncle/php-autosemver .
        - docker push docker.jbuncle.co.uk/jbuncle/php-autosemver
    only:
        refs:
            - master